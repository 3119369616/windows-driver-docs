---
title: Checksum Offload
description: Checksum offload usage, rules, and example
ms.assetid:
keywords:
- WDF Network Adapter Class Extension Offloads, NetAdapterCx hardware offloads, NetAdapterCx Offloads, NetAdapter Offloads, Checksum Offload
ms.date: 01/18/2019
ms.custom: 19H1
---

# Checksum Offload

NetAdapterCx supports offloading TCP/IP checksum tasks at run time.

Before passing to the miniport driver a NET_PACKET structure for a packet on which the miniport driver will perform checksum tasks, the TCP/IP transport specifies the checksum information that is associated with the NET_PACKET structure. This information is specified by a NET_PACKET_CHECKSUM structure, which is a packet extension.

Before offloading the checksum calculation for a TCP packet, the TCP/IP transport calculates the one's complement sum for the TCP pseudoheader. The TCP/IP transport calculates the one's complement sum across all fields in the pseudoheader, including Source IP Address, Destination IP Address, Protocol, and the TCP length for TCP packets. The TCP/IP transport enters the one's complement sum for the pseudoheader in the Checksum field of the TCP header, similar to how it's done in NDIS.

The one's complement sum for the pseudoheader provided by the TCP/IP transport gives the NIC an early start in calculating the real TCP checksum for the send packet. To calculate the actual TCP checksum, the NIC calculates the variable part of the TCP checksum (for the TCP header and payload), adds this checksum to the one's complement sum for the pseudoheader calculated by the TCP/IP transport, and calculates the 16-bit one's complement for the checksum. For more information about calculating such checksums, see RFC 793 and RFC 1122.

The TCP/IP transport computes the one's complement sum for the pseudoheader of a UDP packet using the same steps as it does for a TCP packet, and stores the value in the Checksum field of the UDP header.

Note that the TCP/IP transport always ensures that the checksum field in the IP header of a packet is set to zero before passing the packet to an underlying miniport driver. The miniport driver should ignore the checksum field in an IP header. The miniport driver does not need to verify that the checksum field is set to zero and does not need to set this field to zero.

Turning off Checksum Offloads when Generic Segmentation Offload (GSO) is enabled does not prevent the miniport driver from computing and inserting checksums in the packets generated by the GSO feature. To disable Checksum Offloads in this case the user must also disable GSO.

## INF keywords for controlling checksum offload

The checksum keywords specified in [Using Registry Values to Enable and Disable Task Offloading](https://docs.microsoft.com/windows-hardware/drivers/network/using-registry-values-to-enable-and-disable-task-offloading) can be used to enable/disable the checksum offload with a registry key setting.

## Configuring checksum offload

Client drivers first advertise their hardware's checksum offload capabilities during net adapter initialization. This might occur within the context of [*EvtDevicePrepareHardware*](https://docs.microsoft.com/windows-hardware/drivers/ddi/wdfdevice/nc-wdfdevice-evt_wdf_device_prepare_hardware) when starting a net adapter. To get started, the client driver allocates a capabilities structure for each supported offload, initializes them, and calls the appropriate **NetAdapterOffloadSetXxxCapabilities** methods to register them with NetAdapterCx. During the call to **NET_ADAPTER_OFFLOAD_XxX_CAPABILITIES_INIT**, the driver provides a pointer to a callback function that the system invokes later if active hardware offload capabilities change.

### Rules for indicating hardware transmit checksum capabilities

1. The Layer3Flags and Layer4Flags must be used to indicate which packets the NIC is capable of performing checksum offload on.
2. The Layer3HeaderOffsetLimit and Layer4HeaderOffsetLimit are optional. If the OS sends a packet with a header offset greater than the limit specified, it will not request the checksum to be calculated by the NIC for that layer.
3. IP/TCP packets without options/extensions must be supported if options/extensions are supported.

### Rules for indicating hardware receive checksum capabilities

NetAdapterCx does not require the hardware receive checksum capabilities to be advertised by the driver. The NIC should perform checksum on all the packets it can handle, if the checksum offload is enabled. 

This example shows how a client driver might set up its hardware checksum offload capabilities.

```C++
VOID
MyAdapterSetOffloadCapabilities(
    NETADAPTER NetAdapter
)
{
    // Configure the hardware's Tx checksum offload capabilities
    NET_ADAPTER_OFFLOAD_TX_CHECKSUM_CAPABILITIES txChecksumOffloadCapabilities;

    auto const layer3Flags = NetAdapterOffloadFlagIPv4WithoutOptions |
        NetAdapterOffloadFlagIPv4WithOptions |
        NetAdapterOffloadFlagIPv6WithoutExtensions |
        NetAdapterOffloadFlagIPv6WithExtensions;

    auto const layer4Flags = NetAdapterOffloadFlagTcpWithoutOptions |
        NetAdapterOffloadFlagTcpWithOptions |
        NetAdapterOffloadFlagUdp;

    NET_ADAPTER_OFFLOAD_TX_CHECKSUM_CAPABILITIES_INIT(
        &txChecksumOffloadCapabilities,
        layer3Flags,
        layer4Flags,
        EvtAdapterOffloadSetTxChecksum);

    txChecksumOffloadCapabilities.Layer4HeaderOffsetLimit = 127;

    // Set the current Tx checksum offload capabilities and register the callback for future changes in active capabilities
    NetAdapterOffloadSetTxChecksumCapabilities(NetAdapter,
        &txChecksumOffloadCapabilities);

    // Configure the hardware's Rx checksum offload capabilities
    NET_ADAPTER_OFFLOAD_RX_CHECKSUM_CAPABILITIES rxChecksumOffloadCapabilities;

    NET_ADAPTER_OFFLOAD_RX_CHECKSUM_CAPABILITIES_INIT(
        &rxChecksumOffloadCapabilities,
        EvtAdapterOffloadSetRxChecksum);

    // Set the current Rx checksum offload capabilities and register the callback for future changes in active capabilities
    NetAdapterOffloadSetRxChecksumCapabilities(NetAdapter,
        &rxChecksumOffloadCapabilities);
}
```

## Updating hardware offloads

If the TCP/IP stack or an overlying protocol driver requests a change in active capabilities of the network adapter, NetAdapterCx invokes the client driver's *EVT_NET_ADAPTER_OFFLOAD_SET_XxX* callback function that was previously registered during adapter initialization. In this function, the system supplies updated capabilities in the NETOFFLOAD object, which the client driver can query and use to update its offload capabilities.

The following example shows how a client driver might update its Tx/Rx checksum offload capabilities:

```C++
VOID
MyEvtAdapterOffloadSetTxChecksum(
	NETADAPTER 	NetAdapter,
	NETOFFLOAD	Offload
)
{
	PMY_NET_ADAPTER_CONTEXT adapterContext = MyGetNetAdapterContext(NetAdapter);

	// Store the updated information in the context
	adapterContext->TxHardwareIpChecksum = NetOffloadIsTxChecksumIPv4Enabled(Offload);
	adapterContext->TxHardwareTcpChecksum = NetOffloadIsTxChecksumTcpEnabled(Offload);
	adapterContext->TxHardwareUdpChecksum = NetOffloadIsTxChecksumUdpEnabled(Offload);

	// Update the new hardware Tx checksum offload capabilities
	MyUpdateHardwareChecksum(adapterContext);
}

VOID
MyEvtAdapterOffloadSetRxChecksum(
	NETADAPTER 	NetAdapter,
	NETOFFLOAD	Offload
)
{
	PMY_NET_ADAPTER_CONTEXT adapterContext = MyGetNetAdapterContext(NetAdapter);

	// Store the updated information in the context
	adapterContext->RxHardwareIpChecksum = NetOffloadIsRxChecksumIPv4Enabled(Offload);
	adapterContext->RxHardwareTcpChecksum = NetOffloadIsRxChecksumTcpEnabled(Offload);
	adapterContext->RxHardwareUdpChecksum = NetOffloadIsRxChecksumUdpEnabled(Offload);

	// Update the new hardware Rx checksum offload capabilities
	MyUpdateHardwareChecksum(adapterContext);
}
```

## Transmit checksum

A miniport driver typically does the following checksum processing on the transmit path:

1. The miniport driver calls the NetExtensionGetPacketChecksum function with the packet index to obtain a NET_PACKET_CHECKSUM structure.

2. The miniport driver tests the layer-specific flags in the NET_PACKET_CHECKSUM structure. For each layer, if the flag is `NetPacketTxChecksumActionPassthrough`, the NIC should not perform checksum operations in that layer.

3. If the flag is `NetPacketTxChecksumActionRequired`, the miniport driver should determine the protocol being used at that layer in that specific packet using the NET_PACKET_LAYOUT and indicate to the NIC which checksum it should calculate for the packet.

4. The miniport driver passes the packet to the NIC, which calculates the appropriate checksums for the packet.

## Receive checksum

Before indicating a NET_PACKET structure for a receive packet on which it performs checksum tasks, the miniport driver validates the appropriate checksums and sets the appropriate flags in the NET_PACKET_CHECKSUM structure.

The flags can be one of the following:

| Flag | Description |
| --- | --- |
| NetPacketRxChecksumEvaluationNotChecked | The NIC could not validate the checksum of the packet |
| NetPacketRxChecksumEvaluationValid | The checksum of the packet is valid |
| NetPacketRxChecksumEvaluationInvalid | The checksum of the packet is invalid |

## Related links

[**NET_ADAPTER_OFFLOAD_TX_CHECKSUM_CAPABILITIES**](https://docs.microsoft.com/windows-hardware/drivers/ddi/netadapter/ns-netadapter-_net_adapter_offload_tx_checksum_capabilities)

[**NET_ADAPTER_OFFLOAD_TX_CHECKSUM_CAPABILITIES_INIT**](https://docs.microsoft.com/windows-hardware/drivers/ddi/netadapter/nf-netadapter-net_adapter_offload_tx_checksum_capabilities_init)

[**NetAdapterOffloadSetTxChecksumCapabilities**](https://docs.microsoft.com/windows-hardware/drivers/ddi/netadapter/nf-netadapter-netadapteroffloadtxsetchecksumcapabilities)

[*EvtNetAdapterOffloadSetTxChecksum*](https://docs.microsoft.com/windows-hardware/drivers/ddi/netadapter/nc-netadapter-evt_net_adapter_offload_set_tx_checksum)

[**NET_ADAPTER_OFFLOAD_RX_CHECKSUM_CAPABILITIES**](https://docs.microsoft.com/windows-hardware/drivers/ddi/netadapter/ns-netadapter-_net_adapter_offload_rx_checksum_capabilities)

[**NET_ADAPTER_OFFLOAD_RX_CHECKSUM_CAPABILITIES_INIT**](https://docs.microsoft.com/windows-hardware/drivers/ddi/netadapter/nf-netadapter-net_adapter_offload_rx_checksum_capabilities_init)

[**NetAdapterOffloadSetRxChecksumCapabilities**](https://docs.microsoft.com/windows-hardware/drivers/ddi/netadapter/nf-netadapter-netadapteroffloadsetrxchecksumcapabilities)

[*EvtNetAdapterOffloadSetRxChecksum*](https://docs.microsoft.com/windows-hardware/drivers/ddi/netadapter/nc-netadapter-evt_net_adapter_offload_set_rx_checksum)
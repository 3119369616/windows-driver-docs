---
title: Checksum Offload
description: Checksum offload usage, rules, and example
ms.assetid:
keywords:
- WDF Network Adapter Class Extension Offloads, NetAdapterCx hardware offloads, NetAdapterCx Offloads, NetAdapter Offloads, Checksum Offload
ms.date: 08/10/2020
ms.custom: Fe
---

# Checksum Offload

NetAdapterCx supports offloading TCP/IP checksum tasks at run time.

Before the TCP/IP transport passes a [**NET_PACKET**](/windows-hardware/drivers/ddi/packet/ns-packet-_net_packet) structure to the client driver, it specifies the checksum information associated with the NET_PACKET in a [**NET_PACKET_CHECKSUM**](/windows-hardware/drivers/ddi/checksumtypes/ns-checksumtypes-_net_packet_checksum) packet extension.

<!--
The TCP/IP transport specifies the checksum information associated with a [NET_PACKET](/windows-hardware/drivers/ddi/packet/ns-packet-_net_packet) structure before it passes the NET_PACKET to the client driver. The TCP/IP transport updates a [NET_PACKET_CHECKSUM](/windows-hardware/drivers/ddi/checksumtypes/ns-checksumtypes-_net_packet_checksum) packet extension which describes the checksum information.

Before passing to the client driver a NET_PACKET structure for a packet on which the client driver will perform checksum tasks, the TCP/IP transport specifies the checksum information that is associated with the NET_PACKET structure. This information is specified by a [NET_PACKET_CHECKSUM](/windows-hardware/drivers/ddi/checksumtypes/ns-checksumtypes-_net_packet_checksum) packet extension.
-->

Before offloading the checksum calculation for a TCP/UDP packet, the TCP/IP transport calculates the one's complement sum for the TCP/UDP pseudoheader as described in [Offloading Checksum Tasks](../network/offloading-checksum-tasks.md).

Turning off checksum offloads when [Generic Segmentation Offload](gso-offload.md) (GSO) is enabled doesn't prevent the client driver from computing and inserting checksums in packets generated by the GSO feature. To disable checksum offloads you must also disable GSO.

## INF keywords for controlling checksum offload

The driver doesn't need to worry about checking standard registry keywords. NetAdapterCx checks the registry keywords and honors them when enabling the active offload capabilities.

The checksum keywords specified in [Using Registry Values to Enable and Disable Task Offloading](../network/using-registry-values-to-enable-and-disable-task-offloading.md) can be used to enable/disable the checksum offload with a registry key setting.

## Configuring checksum offload

Client drivers first advertise their hardware's checksum offload capabilities during net adapter initialization. This might occur within their [**EvtDevicePrepareHardware**](/windows-hardware/drivers/ddi/wdfdevice/nc-wdfdevice-evt_wdf_device_prepare_hardware) callback before starting a net adapter.

To configure each checksum offload (transmit and receive) a client driver supports, the driver:

1. Allocates a **NET_ADAPTER_OFFLOAD_Xxx_CHECKSUM_CAPABILITIES** structure.
2. Calls **NET_ADAPTER_OFFLOAD_Xxx_CHECKSUM_CAPABILITIES_INIT** to initialize the structure.
3. Calls **NetAdapterOffloadSetXxxChecksumCapabilities** to register the structure with NetAdapterCx.

<!--
The client driver allocates a capabilities structure for each supported checksum offload (transmit and receive), initializes them, and calls the appropriate **NetAdapterOffloadSetXxxChecksumCapabilities** methods to register them with NetAdapterCx. 
-->
During the call to **NET_ADAPTER_OFFLOAD_Xxx_CHECKSUM_CAPABILITIES_INIT**, the driver provides a pointer to a **EVT_NET_ADAPTER_OFFLOAD_SET_Xxx** callback function that the system invokes later if active offload capabilities change.

### Rules for indicating hardware transmit checksum capabilities

1. The Layer3Flags and Layer4Flags in the [**NET_ADAPTER_OFFLOAD_TX_CHECKSUM_CAPABILITIES**](/windows-hardware/drivers/ddi/netadapteroffload/ns-netadapteroffload-_net_adapter_offload_tx_checksum_capabilities) structure must be used to indicate which packets the NIC is capable of performing checksum offload on.
2. The Layer3HeaderOffsetLimit and Layer4HeaderOffsetLimit in **NET_ADAPTER_OFFLOAD_TX_CHECKSUM_CAPABILITIES** are optional. If the OS sends a packet with a header offset greater than the limit specified, it will not request the NIC to calculate the checksum for that layer.
3. IP/TCP packets without options/extensions must be supported if options/extensions are supported.

### Rules for indicating hardware receive checksum capabilities

NetAdapterCx does not require the driver to advertise the hardware receive checksum capabilities. The NIC should perform checksum offload on all the packets it can handle if the checksum offload is enabled. If the NIC can't perform checksum offload on a packet NetAdapterCx will offload it in software.

This example shows how a client driver might set up its hardware checksum offload capabilities.

```C++
VOID
MyAdapterSetOffloadCapabilities(
    NETADAPTER NetAdapter
)
{
    // Configure the hardware's Tx checksum offload capabilities
    NET_ADAPTER_OFFLOAD_TX_CHECKSUM_CAPABILITIES txChecksumOffloadCapabilities;

    auto const layer3Flags = NetAdapterOffloadFlagIPv4WithoutOptions |
        NetAdapterOffloadFlagIPv4WithOptions |
        NetAdapterOffloadFlagIPv6WithoutExtensions |
        NetAdapterOffloadFlagIPv6WithExtensions;

    auto const layer4Flags = NetAdapterOffloadFlagTcpWithoutOptions |
        NetAdapterOffloadFlagTcpWithOptions |
        NetAdapterOffloadFlagUdp;

    NET_ADAPTER_OFFLOAD_TX_CHECKSUM_CAPABILITIES_INIT(
        &txChecksumOffloadCapabilities,
        layer3Flags,
        layer4Flags,
        EvtAdapterOffloadSetTxChecksum);

    txChecksumOffloadCapabilities.Layer4HeaderOffsetLimit = 127;

    // Set the current Tx checksum offload capabilities and register the callback for future changes in active capabilities
    NetAdapterOffloadSetTxChecksumCapabilities(NetAdapter,
        &txChecksumOffloadCapabilities);

    // Configure the hardware's Rx checksum offload capabilities
    NET_ADAPTER_OFFLOAD_RX_CHECKSUM_CAPABILITIES rxChecksumOffloadCapabilities;

    NET_ADAPTER_OFFLOAD_RX_CHECKSUM_CAPABILITIES_INIT(
        &rxChecksumOffloadCapabilities,
        EvtAdapterOffloadSetRxChecksum);

    // Set the current Rx checksum offload capabilities and register the callback for future changes in active capabilities
    NetAdapterOffloadSetRxChecksumCapabilities(NetAdapter,
        &rxChecksumOffloadCapabilities);
}
```

## Updating hardware offloads

If the TCP/IP stack or an overlying protocol driver requests a change to the net adapter's active capabilities NetAdapterCx invokes the client driver's **EVT_NET_ADAPTER_OFFLOAD_SET_Xxx** callback registered during adapter initialization. In this function, the system supplies updated capabilities in the NETOFFLOAD object which the client driver can query and use to update its offload capabilities.

The following example shows how a client driver might update its Tx/Rx checksum offload capabilities:

```C++
VOID
MyEvtAdapterOffloadSetTxChecksum(
	NETADAPTER 	NetAdapter,
	NETOFFLOAD	Offload
)
{
	PMY_NET_ADAPTER_CONTEXT adapterContext = MyGetNetAdapterContext(NetAdapter);

	// Store the updated information in the context
	adapterContext->TxHardwareIpChecksum = NetOffloadIsTxChecksumIPv4Enabled(Offload);
	adapterContext->TxHardwareTcpChecksum = NetOffloadIsTxChecksumTcpEnabled(Offload);
	adapterContext->TxHardwareUdpChecksum = NetOffloadIsTxChecksumUdpEnabled(Offload);

	// Update the new hardware Tx checksum offload capabilities
	MyUpdateHardwareChecksum(adapterContext);
}

VOID
MyEvtAdapterOffloadSetRxChecksum(
	NETADAPTER 	NetAdapter,
	NETOFFLOAD	Offload
)
{
	PMY_NET_ADAPTER_CONTEXT adapterContext = MyGetNetAdapterContext(NetAdapter);

	// Store the updated information in the context
	adapterContext->RxHardwareIpChecksum = NetOffloadIsRxChecksumIPv4Enabled(Offload);
	adapterContext->RxHardwareTcpChecksum = NetOffloadIsRxChecksumTcpEnabled(Offload);
	adapterContext->RxHardwareUdpChecksum = NetOffloadIsRxChecksumUdpEnabled(Offload);

	// Update the new hardware Rx checksum offload capabilities
	MyUpdateHardwareChecksum(adapterContext);
}
```

## Transmit checksum

A client driver typically does the following checksum processing on the transmit path:

1. The client driver calls the NetExtensionGetPacketChecksum function with the packet index to obtain a NET_PACKET_CHECKSUM structure.

2. The client driver tests the layer-specific flags in the NET_PACKET_CHECKSUM structure. For each layer, if the flag is `NetPacketTxChecksumActionPassthrough`, the NIC should not perform checksum operations in that layer.

3. If the flag is `NetPacketTxChecksumActionRequired`, the client driver should determine the protocol being used at that layer in that specific packet using the NET_PACKET_LAYOUT and indicate to the NIC which checksum it should calculate for the packet.

4. The client driver passes the packet to the NIC, which calculates the appropriate checksums for the packet.

## Receive checksum

Before indicating a NET_PACKET structure for a receive packet on which it performs checksum tasks, the client driver validates the checksums and sets the appropriate flags in the NET_PACKET_CHECKSUM structure.

The flags can be one of the following:

| Flag | Description |
| --- | --- |
| NetPacketRxChecksumEvaluationNotChecked | The NIC could not validate the checksum of the packet |
| NetPacketRxChecksumEvaluationValid | The checksum of the packet is valid |
| NetPacketRxChecksumEvaluationInvalid | The checksum of the packet is invalid |

## Related links

[**NET_ADAPTER_OFFLOAD_TX_CHECKSUM_CAPABILITIES**](https://docs.microsoft.com/windows-hardware/drivers/ddi/netadapter/ns-netadapter-_net_adapter_offload_tx_checksum_capabilities)

[**NET_ADAPTER_OFFLOAD_TX_CHECKSUM_CAPABILITIES_INIT**](https://docs.microsoft.com/windows-hardware/drivers/ddi/netadapter/nf-netadapter-net_adapter_offload_tx_checksum_capabilities_init)

[**NetAdapterOffloadSetTxChecksumCapabilities**](https://docs.microsoft.com/windows-hardware/drivers/ddi/netadapter/nf-netadapter-netadapteroffloadtxsetchecksumcapabilities)

[**EVT_NET_ADAPTER_OFFLOAD_SET_TX_CHECKSUM**](https://docs.microsoft.com/windows-hardware/drivers/ddi/netadapter/nc-netadapter-evt_net_adapter_offload_set_tx_checksum)

[**NET_ADAPTER_OFFLOAD_RX_CHECKSUM_CAPABILITIES**](https://docs.microsoft.com/windows-hardware/drivers/ddi/netadapter/ns-netadapter-_net_adapter_offload_rx_checksum_capabilities)

[**NET_ADAPTER_OFFLOAD_RX_CHECKSUM_CAPABILITIES_INIT**](https://docs.microsoft.com/windows-hardware/drivers/ddi/netadapter/nf-netadapter-net_adapter_offload_rx_checksum_capabilities_init)

[**NetAdapterOffloadSetRxChecksumCapabilities**](https://docs.microsoft.com/windows-hardware/drivers/ddi/netadapter/nf-netadapter-netadapteroffloadsetrxchecksumcapabilities)

[**EVT_NET_ADAPTER_OFFLOAD_SET_RX_CHECKSUM**](https://docs.microsoft.com/windows-hardware/drivers/ddi/netadapter/nc-netadapter-evt_net_adapter_offload_set_rx_checksum)
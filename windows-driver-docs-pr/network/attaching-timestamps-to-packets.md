---
title: Attaching timestamps to packets
description: Attaching hardware and software timestamps to packets
ms.date: 12/31/2020
ms.localizationpriority: medium
---

# Attaching timestamps to packets

The various types of hardware and software timestamps which a NIC and miniport driver can support are listed and described on the [**NDIS_TIMESTAMP_CAPABILITY_FLAGS**](/windows-hardware/drivers/ddi/ntddndis/ns-ntddndis-_ndis_timestamp_capability_flags) structure page. The miniport driver indicates the current settings  for these timestamps to the operating system using the [**NDIS_STATUS_TIMESTAMP_CURRENT_CONFIG**](ndis-status-timestamp-current-config.md) status indication.

## Hardware timestamps
The `PtpV2OverUdpIPv4EventMsgReceiveHw`, `PtpV2OverUdpIPv4AllMsgReceiveHw`, `PtpV2OverUdpIPv4EventMsgTransmitHw`, `PtpV2OverUdpIPv4AllMsgTransmitHw`, `PtpV2OverUdpIPv6EventMsgReceiveHw`, `PtpV2OverUdpIPv6AllMsgReceiveHw`, `PtpV2OverUdpIPv6EventMsgTransmitHw`, `PtpV2OverUdpIPv6AllMsgTransmitHw`, `AllReceiveHw`, `AllTransmitHw` and `TaggedTransmitHw` flags in the **NDIS_TIMESTAMP_CAPABILITY_FLAGS** structure indicate which hardware timestamps the miniport driver supports.

The timestamp that the NIC hardware generates on reception or transmission of a packet is represented by a 64-bit integer value. This value should be the raw value of the NIC hardware's clock at the point the timestamp is captured. The timestamp is stored in the [**NET\_BUFFER\_LIST**](/windows-hardware/drivers/ddi/nbl/ns-nbl-net_buffer_list) (NBL) structure's **NetBufferListInfo** array.

Miniport drivers can use the [**NET_BUFFER_LIST_TIMESTAMP**](/windows-hardware/drivers/ddi/nbltimestamp/ns-nbltimestamp-net_buffer_list_timestamp) structure to set the timestamp in the NBL's **NetBufferListInfo** field. The driver fills the **Timestamp** field of the **NET_BUFFER_LIST_TIMESTAMP** structure with the timestamp generated by the hardware and calls the [**NdisSetNblTimestampInfo**](/windows-hardware/drivers/ddi/nbltimestamp/nf-nbltimestamp-ndissetnbltimestampinfo) utility function, passing in the structure. 

Miniport drivers can use [**NdisGetNblTimestampInfo**](/windows-hardware/drivers/ddi/nbltimestamp/nf-nbltimestamp-ndisgetnbltimestampinfo) and [**NdisCopyNblTimestampInfo**](/windows-hardware/drivers/ddi/nbltimestamp/nf-nbltimestamp-ndiscopynbltimestampinfo) to retrieve and copy timestamps.

If a hardware timestamp setting is enabled but the timestamp couldn't be generated, the timestamp attached to the NBL should be set to **zero**.

### Receive side timestamping

Depending on the hardware capabilities and the currently enabled timestamping configuration, the timestamp generated in the hardware during reception of a packet is attached by the miniport driver to the NBL before the NBL is indicated to NDIS by calling the [**NdisMIndicateReceiveNetBufferLists**](/windows-hardware/drivers/ddi/ndis/nf-ndis-ndismindicatereceivenetbufferlists) function. The timestamp attached to the NBL corresponds to the frame (the [**NET_BUFFER**](/windows-hardware/drivers/ddi/ndis/ns-ndis-_net_buffer) structure) contained in the NBL. Note that in the receive direction, miniport drivers for Ethernet hardware are required to indicate only one **NET_BUFFER** per NBL.

The hardware timestamp should be obtained as close as possible to the point when the hardware receives the frame from the medium. This guideline is specified by the IEEE 1588 standard.

The timestamp attached to the NBL must also be corrected for any delays (if any exist) between when the timestamp is captured and when the frame was actually received by the hardware.

### Transmit side timestamping

Depending on the hardware capabilities and the currently enabled timestamping config, the timestamp generated in the hardware during transmission of a packet is attached by the miniport driver to the NBL before the NBL is send completed to NDIS by calling the [**NdisMSendNetBufferListsComplete**](/windows-hardware/drivers/ddi/ndis/nf-ndis-ndismsendnetbufferlistscomplete) function.

The hardware timestamp should be obtained as close as possible to the point when the hardware transmits the frame to the medium. This guideline is specified by the IEEE 1588 standard.

The timestamp attached to the NBL must also be corrected for any delays (if any exist) between when the timestamp is captured and when the frame was actually transmitted by the hardware.

If a miniport driver is given an NBL to transmit which contains multiple **NET_BUFFER**s, the hardware timestamp corresponding to the first **NET_BUFFER** in the NBL should be attached to the NBL before send completion.

Miniports and NIC hardware that report that the `TaggedTransmitHw` capability flag is supported and currently enabled should check if the `NDIS_NBL_FLAGS_CAPTURE_TIMESTAMP_ON_TRANSMIT` flag is set in the **NblFlags** field of an NBL that is given to the miniport for transmission. If this flag is set, this indicates that a transmit time timestamp is needed for that NBL and a transmit time hardware timestamp should be generated for the NBL.

## Software timestamps

The `AllReceiveSw`, `AllTransmitSw` and `TaggedTransmitSw` flags in the [**NDIS_TIMESTAMP_CAPABILITY_FLAGS**](/windows-hardware/drivers/ddi/ntddndis/ns-ntddndis-_ndis_timestamp_capability_flags) structure indicate if the miniport supports generating software timestamps. 

Software timestamps are also represented as 64-bit integer values and are stored in the same slot in the **NetBufferListInfo** array of the [**NET_BUFFER**](/windows-hardware/drivers/ddi/ndis/ns-ndis-_net_buffer) (NBL) structure as the hardware timestamps.

If software timestamping capabilities are present and enabled, then the miniport driver sets the timestamp in the NBL by taking the value of the performance counter obtained by calling [**KeQueryPerformanceCounter**](/windows-hardware/drivers/ddi/ntifs/nf-ntifs-kequeryperformancecounter) and storing it in the NBL. To store the value in the NBL, the miniport fills the **Timestamp** field of the **NET_BUFFER_LIST_TIMESTAMP** structure with the timestamp and calls [**NdisSetNblTimestampInfo**](/windows-hardware/drivers/ddi/nbltimestamp/nf-nbltimestamp-ndissetnbltimestampinfo), passing in the structure.

On receive the performance counter value (QPC) should be captured as early as possible in the software but no earlier than when the packet arrived.

On transmit the performance counter value (QPC) should be captured as late as possible in software before the packet is given to the hardware for transmission.

The `TaggedTransmitSw` flag is analogous to the `TaggedTransmitHw` flag but corresponds to software timestamps. If the capability is supported and enabled then the miniport should check the  `NDIS_NBL_FLAGS_CAPTURE_TIMESTAMP_ON_TRANSMIT` flag in the **NblFlags** field of the NBL. If this flag is set, a transmit time software timestamp should be generated for the NBL.
# Overview of NDIS packet timestamping

)This API is a part of changes which enable Windows...) 

Starting with NDIS 6.82, the NDIS packet timestamping interface enables Windows to support the hardware timestamping capability of network cards for the Precision Time Protocol (PTP) version 2 protocol. 

Overall these changes include providing the ability to drivers of network cards to support timestamps, for user mode applications to query timestamp configuration (through iphlpapi) and consume timestamps associated with packets (through Winsock). In addition, an ability to generate software timestamps is also introduced as part of these changes which allows a network driver to generate timestamps in software.

The APIs provide the following abilities:

- Provide ability to discover NIC hardware’s timestamping capabilities.

- Provide ability to associate NIC hardware clock’s timestamps to PTP version 2 traffic running over UDP (using the standard UDP ports defined for PTP i.e. 319 and 320).

- Provide ability to use the network hardware’s clock as a free running clock by being able to query the network hardware’s clock to enable establishment of a relation between the network hardware clock and a system clock.

The target of these APIs is Ethernet hardware. The API is intended to work both with NICs which have support specifically for generating hardware timestamps for PTP traffic, as well as with NICs which can generate hardware timestamps for all traffic and so would work with PTP traffic as well.

As mentioned above, the main scenario intended to be supported is PTP version 2. All references to PTP throughout the document should be assumed to apply to PTP version 2 wherever the version of PTP is not explicitly specified.

## Miscellaneous implementation notes (add elsewhere)

- Cross timestamps must be supported when supporting hardware timestamps.

- When recognizing PTPv2 packets to generate hardware timestamps, the implementation should aim as much as possible to not restrict timestamp generation to only those packets which are using the multicast addresses (both IPv4 and IPv6) which are specified by the PTP specification. The implementation should try to recognize PTP packets in other ways, e.g. based on the UDP header, or the PTP payload. This would help in scenarios where a PTP implementation might not be using the multicast addresses specified in the PTP specification e.g. unicast address are being used.
-  
- An implementation must support hardware timestamps. Software timestamps are optional.

- If an implementation finds both hardware and software timestamps as enabled through the keywords, then the miniport should only generate hardware timestamps and disable software timestamps. NDIS_STATUS_TIMESTAMP_CURRENT_CONFIG should take this into account.

# Attaching timestamps to packets

The various types of hardware and software timestamps which a NIC and miniport driver can support are described above in the section which describes the various fields of the NDIS_TIMESTAMP_CAPABILITIES structure. (list?) The miniport indicates the current settings (e.g. enabled\disabled) for these timestamps to the operating system using the NDIS_STATUS_TIMESTAMP_CURRENT_CONFIG status indication.

## Hardware timestamps

The timestamp that the NIC hardware generates on reception or transmission of a packet is represented by a 64 bit integer value. This timestamp will be stored in a slot in the NetBufferListInfo array of the [**NET\_BUFFER\_LIST**](/windows-hardware/drivers/ddi/nbl/ns-nbl-net_buffer_list) (NBL) structure. These timestamps should be the raw value of the clock in the NIC hardware at the point the timestamp is captured.

Miniport drivers can use the NET_BUFFER_LIST_TIMESTAMP structure to help in setting the timestamp in the NetBufferListInfo field of a NBL. To set the timestamp on a NBL, miniport drivers fill the Timestamp field of the NET_BUFFER_LIST_TIMESTAMP structure with the timestamp generated by the hardware and call the NdisSetNblTimestampInfo utility function passing in the structure. NdisGetNblTimestampInfo and NdisCopyNblTimestampInfo are other utility functions which can be used to retrieve and copy timestamps.

If for some reason a hardware timestamp setting is enabled but could not be generated, the timestamp attached to the NBL should be set to 0.

### Receive side timestamping

Depending on the hardware capabilities and the currently enabled timestamping configuration, the timestamp generated in the hardware during reception of a packet is attached by the miniport driver to the NBL before the NBL is indicated to NDIS by calling the NdisMIndicateReceiveNetBufferLists function. The timestamp attached to the NBL corresponds to the frame (NET_BUFFER structure) contained in the NBL. (It should be noted that in receive direction miniport drivers for Ethernet hardware are already required to indicate only one NET_BUFFER per NBL).

The hardware timestamp should be obtained as close as possible to the point of reception of the frame by the hardware from the medium as specified by the IEEE 1588 standard.

The timestamp attached to the NBL must also be corrected for any delays (if any exist) between when the timestamp is captured and when the frame was actually received by the hardware. 

### Transmit side timestamping

Depending on the hardware capabilities and the currently enabled timestamping config, the timestamp generated in the hardware during transmission of a packet is attached by the miniport driver to the NBL before the NBL is send completed to NDIS by calling the NdisMSendNetBufferListsComplete function.

The hardware timestamp should be obtained as close as possible to the point of transmission of the frame by the hardware to the medium as specified by the IEEE 1588 standard.

The timestamp attached to the NBL must also be corrected for any delays (if any exist) between when the timestamp is captured and when the frame was actually transmitted by the hardware.

If a miniport driver is given a NBL to transmit which contains multiple NET_BUFFERs, the hardware timestamp corresponding to the first NET_BUFFER in the NBL should be attached to the NBL before send completion.

Miniports and NIC hardware who report that the TaggedTransmitHw capability flag is supported and currently enabled should check if the NDIS_NBL_FLAGS_CAPTURE_TIMESTAMP_ON_TRANSMIT flag is set in the NblFlags field of a NBL which is given to the miniport for transmission. If this flag is set, then this indicates that a transmit time timestamp is needed for that NBL and a transmit time hardware timestamp should be generated for such a NBL.

## Software timestamps

The AllReceiveSw, AllTransmitSw and TaggedTransmitSw flags in the NDIS_TIMESTAMP_CAPABILITY_FLAGS field indicate if the miniport supports generating software timestamps. Software timestamps are also represented as 64-bit integer values and are stored in the same slot in the NetBufferListInfo array of the NET_BUFFER_LIST (NBL) structure as the hardware timestamps.

If software timestamping capabilities are present and enabled, then the miniport driver sets the timestamp in the NBL by taking the value of the performance counter obtained by calling the KeQueryPerformanceCounter API and storing it in the NBL. This value can be set in the NBL in a similar way as described above for hardware timestamps (i.e. by using the NET_BUFFER_LIST_TIMESTAMP structure and calling the NdisSetNblTimestampInfo utility function).

On receive the performance counter value (QPC) should be captured as early as possible in the software but no earlier than the packet arrived.

On transmit the performance counter value (QPC) should be captured as late as possible in software before the packet is given to the hardware for transmission.

The TaggedTransmitSw flag is analogous to the TaggedTransmitHw flag but corresponds to software timestamps, i.e. if the capability is supported and enabled then NDIS_NBL_FLAGS_CAPTURE_TIMESTAMP_ON_TRANSMIT flag should be checked in NblFlags field of the NBL, and if so a transmit time software timestamp should be generated for such a NBL.

# Reporting NDIS timestamping capabilities

Miniport drivers need to indicate the NIC's hardware timestamping capabilities and the miniport driver's software timestamping capabilities (as well as the current configuration of the timestamping capabilities) to NDIS and overlying drivers. (Both of these would be reported to the operating system through status indications). The support for NDIS timestamping capabilities is enabled or disabled through the setting of the **\*PtpHardwareTimestamp** and **\*SoftwareTimestamp** standardized INF keywords. For more information about these keywords, see [**Standardized INF Keywords for NDIS packet timestamping**](standardized-inf-keywords-for-ndis-packet-timestamping.md).

Add indication info...

* Add inf info?

When NDIS calls the miniport driver's [*MiniportInitializeEx*](/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_initialize) function, the driver indicates its hardware and software timestamp capabilities by following these steps:

1. The driver initializes an [**NDIS_TIMESTAMP_CAPABILITIES**](/windows-hardware/drivers/ddi/ntddndis/ns-ntddndis-_ndis_timestamp_capabilities) structure with the NIC's hardware and software timestamp capabilities.
The  driver sets the members of the **NDIS_TIMESTAMP_CAPABILITIES** structure  as follows:
    * The miniport driver uses the **TimestampFlags** field to indicate the hardware and software timestamp capabilities of the NIC hardware and miniport.

    * The **CrossTimestamp** field should be set to **TRUE** if hardware cross timestamps are supported or **FALSE** if they are not.

    * The **HardwareClockFrequencyHz** field should contain the nominal operating frequency of the hardware clock used for timestamping by the NIC. This data may be used to display the nominal clock frequency to end users for informational purposes.

    * The **Type** field in the **Header** field should be set to **NDIS_OBJECT_TYPE_DEFAULT** and the **Revision** to **NDIS_TIMESTAMP_CAPABILITIES_REVISION_1**.

1. Once it has initialized the [**NDIS_TIMESTAMP_CAPABILITIES**](/windows-hardware/drivers/ddi/ntddndis/ns-ntddndis-_ndis_timestamp_capabilities) structure, the driver generates an [**NDIS_STATUS_TIMESTAMP_CAPABILITY**](ndis-status-timestamp-capability.md) status indication by calling [**NdisMIndicateStatusEx**](/windows-hardware/drivers/ddi/ndis/nf-ndis-ndismindicatestatusex) to report the timestamping capabilities. The **StatusBuffer** field of the [**NDIS\_STATUS\_INDICATION**](/windows-hardware/drivers/ddi/ndis/ns-ndis-_ndis_status_indication) structure should point to the **NDIS_TIMESTAMP_CAPABILITIES** structure.

> [!NOTE] 
> The miniport driver must also generate the [**NDIS_STATUS_TIMESTAMP_CAPABILITY**](ndis-status-timestamp-capability.md) status indication whenever it detects a change in underlying hardware capabilities.

# Reporting the timestamping current configuration?

# Querying packet timestamping capabilities

(For example:

Once the miniport driver is initialized, overlying drivers and applications can issue the following OID query requests to obtain the packet coalescing capabilities of the network adapter:

-   [OID\_RECEIVE\_FILTER\_HARDWARE\_CAPABILITIES](./oid-receive-filter-hardware-capabilities.md)

-   [OID\_RECEIVE\_FILTER\_CURRENT\_CAPABILITIES](./oid-receive-filter-current-capabilities.md)

-   [OID\_RECEIVE\_FILTER\_GLOBAL\_PARAMETERS](./oid-receive-filter-global-parameters.md)

NDIS handles these OID query requests for miniport drivers and returns the packet coalescing capabilities that the miniport driver registered when NDIS called the driver's [*MiniportInitializeEx*](/windows-hardware/drivers/ddi/ndis/nc-ndis-miniport_initialize) function. Therefore, these OID query requests are not handled by miniport drivers.

For more information about how the miniport driver registers its packet coalescing capabilities, see [Determining Receive Filtering Capabilities](determining-receive-filtering-capabilities.md).

end)

An overlying driver issues an object identifier (OID) query request of OID_TIMESTAMP_CAPABILITY to obtain the hardware timestamping capabilities of the NIC and software timestamping capabilities of the miniport driver.

An overlying driver issues an object identifier (OID) query request of OID_TIMESTAMP_GET_CROSSTIMESTAMP to obtain the cross timestamp from the NIC hardware. Precision Time Protocol (PTP) version 2 applications use the information provided in this OID to establish a relation between the NIC’s hardware clock and a system clock. 

# NDIS packet timestamping implementation guidelines?

